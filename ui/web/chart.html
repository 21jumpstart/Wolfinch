<html lang="en">

<head>
<title>OldMonk Trading Bot</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>

<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
	integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
	crossorigin="anonymous"></script> -->

<link href="stylesheet.css" rel="stylesheet">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
	integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
	crossorigin="anonymous"></script>


<link rel="stylesheet" type="text/css"
	href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">

<script type="text/javascript" charset="utf8"
	src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>

<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://techanjs.org/techan.min.js"></script>

<!-- 
<script>

	var dim = {
		width : 1160,
		height : 500,
		margin : {
			top : 20,
			right : 50,
			bottom : 30,
			left : 50
		},
	//indicator: { height: 65, padding: 5 }
	};

	dim.ohlc = {
		height : dim.height - dim.margin.top - dim.margin.bottom
	};
	dim.plot = {
		width : dim.width - dim.margin.left - dim.margin.right,
		height : dim.height - dim.margin.top - dim.margin.bottom
	};
	//dim.indicator.top = dim.ohlc.height+dim.indicator.padding;
	//dim.indicator.bottom = dim.indicator.top+dim.indicator.height+dim.indicator.padding;

	var x = techan.scale.financetime().range([ 0, dim.plot.width ]);

	var y = d3.scaleLinear().range([ dim.ohlc.height, 0 ]);

	var zoom = d3.zoom().on("zoom", zoomed);

	var yPercent = y.copy(); // Same as y at this stage, will get a different domain later

	var yInit, yPercentInit, zoomableInit;
	var yVolume = d3.scaleLinear().range([ y(0), y(0.2) ]);

	var candlestick = techan.plot.candlestick().xScale(x).yScale(y);

	var tradearrow = techan.plot.tradearrow().xScale(x).yScale(y).y(
			function(d) {
				//console.log ("trade arrow "+d);
				// Display the buy and sell arrows a bit above and below the price, so the price is still visible
				if (d.type === 'buy')
					return y(d.low) + 5;
				if (d.type === 'sell')
					return y(d.high) - 5;
				else
					return y(d.price);
			});

	var xAxis = d3.axisBottom().scale(x);

	var yAxis = d3.axisLeft().scale(y);

	var timeAnnotation = techan.plot.axisannotation().axis(xAxis).orient(
			'bottom').format(d3.timeFormat('%Y-%m-%d')).width(65).translate(
			[ 0, dim.plot.height ]);

	var volume = techan.plot.volume().accessor(candlestick.accessor()) // Set the accessor to a ohlc accessor so we get highlighted bars
	.xScale(x).yScale(yVolume);

	var closeAnnotation = techan.plot.axisannotation().axis(yAxis).orient(
			'right').accessor(candlestick.accessor()).format(d3.format(',.2f'))
			.translate([ x(1), 0 ]);

	var ohlcAnnotation = techan.plot.axisannotation().axis(yAxis).orient(
			'right').format(d3.format(',.2f')).translate([ x(1), 0 ]);

	var percentAxis = d3.axisLeft(yPercent).tickFormat(d3.format('+.1%'));

	var percentAnnotation = techan.plot.axisannotation().axis(percentAxis)
			.orient('left');

	var volumeAxis = d3.axisRight(yVolume).ticks(3).tickFormat(
			d3.format(",.3s"));

	var volumeAnnotation = techan.plot.axisannotation().axis(volumeAxis)
			.orient("right").width(35);

	var ohlcCrosshair = techan.plot.crosshair().xScale(
			timeAnnotation.axis().scale())
			.yScale(ohlcAnnotation.axis().scale()).xAnnotation(timeAnnotation)
			.yAnnotation(
					[ ohlcAnnotation, percentAnnotation, volumeAnnotation ])
			.verticalWireRange([ 0, dim.plot.height ]);

	var indicatorPreRoll = 33;

	var svg, g_data, g_trades;

	//var parseDate = d3.timeParse("%d-%b-%y");
	var parseDate = function(utcSeconds) {
		var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
		d.setUTCSeconds(utcSeconds);
		return d;
	}

	function zoomed() {
		x.zoomable().domain(d3.event.transform.rescaleX(zoomableInit).domain());
		y.domain(d3.event.transform.rescaleY(yInit).domain());
		yPercent.domain(d3.event.transform.rescaleY(yPercentInit).domain());

		draw(g_data);
	}

	$(document).ready(
			function() {
				console.log("ready!");

				svg = d3.select("#chart").append("svg")
						.attr("width", dim.width).attr("height", dim.height);

				var defs = svg.append("defs");

				defs.append("clipPath").attr("id", "ohlcClip").append("rect")
						.attr("x", 0).attr("y", 0)
						.attr("width", dim.plot.width).attr("height",
								dim.ohlc.height);

				svg = svg.append("g").attr(
						"transform",
						"translate(" + dim.margin.left + "," + dim.margin.top
								+ ")");

				svg.append('text').attr("class", "symbol").attr("x", 20).text(
						"CBPRO: BTC-USD");

				//svg.append("g")
				//		        .attr("class", "x axis")
				//		        .attr("transform", "translate(0," + dim.plot.height + ")");

				var ohlcSelection = svg.append("g").attr("class", "ohlc").attr(
						"transform", "translate(0,0)");

				ohlcSelection.append("g").attr("class", "axis").attr(
						"transform", "translate(" + x(1) + ",0)")
						.append("text").attr("transform", "rotate(-90)").attr(
								"y", -12).attr("dy", ".71em").style(
								"text-anchor", "end").text("Price ($)");

				ohlcSelection.append("g").attr("class", "close annotation up");

				ohlcSelection.append("g").attr("class", "volume").attr(
						"clip-path", "url(#ohlcClip)");

				ohlcSelection.append("g").attr("class", "candlestick").attr(
						"clip-path", "url(#ohlcClip)");

				ohlcSelection.append("g").attr("class", "percent axis");

				ohlcSelection.append("g").attr("class", "volume axis");

				// Add trendlines and other interactions last to be above zoom pane
				svg.append('g').attr("class", "crosshair ohlc");

				svg.append("g").attr("class", "tradearrow").attr("clip-path",
						"url(#ohlcClip)");

				d3.json("../api/candles", load_data);

				d3.json("../api/positions", load_trades);
			});

	function load_trades(error, data) {
		var trades = [];

		console.log("positions data len: " + data.length);
		//data = data.slice(0, 200).map(function(d) {
		for (var i = 0; i < data.length; i++) {

			d = data[i];
			if (d.closed_time && d.closed_time != "None") {
				//console.log ("closed_time: "+d.closed_time+" price:"+d.sell.price)
				trades.push({
					date : d3.isoParse(d.closed_time),
					type : "sell",
					price : d.sell.price,
					low : d.sell.price,
					high : d.sell.price
				});
			}

			if (d.open_time && d.open_time != "None") {
				//console.log ("open_time: "+d.open_time+" price:"+d.buy.price)
				trades.push({
					date : d3.isoParse(d.open_time),
					type : "buy",
					price : d.buy.price,
					low : d.buy.price,
					high : d.buy.price
				});
			}

		}

		g_trades = trades;

		//trades.sort(function(a, b) { return d3.ascending(accessor.d(a), accessor.d(b)); });    
	}

	function load_data(error, data) {

		var accessor = candlestick.accessor();

		console.log("data len: " + data.length);
		//data = data.slice(0, 200).map(function(d) {
		g_data = data = data.map(function(d) {

			//console.log(d)
			return {
				date : parseDate(d.time),
				open : +d.open,
				high : +d.high,
				low : +d.low,
				close : +d.close,
				volume : +d.volume
			};
		}).sort(function(a, b) {
			return d3.ascending(accessor.d(a), accessor.d(b));
		});

		x.domain(techan.scale.plot.time(data).domain());
		y.domain(techan.scale.plot.ohlc(data.slice(indicatorPreRoll)).domain());
		yPercent.domain(techan.scale.plot.percent(y,
				accessor(data[indicatorPreRoll])).domain());
		yVolume.domain(techan.scale.plot.volume(data).domain());

		svg.append("g").attr("class", "candlestick");

		svg.append("g").attr("class", "x axis").attr("transform",
				"translate(0," + dim.plot.height + ")");

		//console.log ("here2"+data);  
		// Data to display initially
		draw(data); //.slice(0, data.length-20));

		// Only want this button to be active if the data has loaded
		d3.select("button").on("click", function() {
			draw(data);
		}).style("display", "inline");

	}

	function draw(data) {
		console.log("plotting");

		x.domain(data.map(candlestick.accessor().d));
		y.domain(techan.scale.plot.ohlc(data, candlestick.accessor()).domain());

		svg.selectAll("g.candlestick").datum(data).call(candlestick);
		svg.selectAll("g.x.axis").call(xAxis);
		svg.selectAll("g.y.axis").call(yAxis);

		svg.select("g.close.annotation").datum([ data[data.length - 1] ]).call(
				closeAnnotation);
		svg.select("g.volume").datum(data).call(volume);

		//        svg.select("g.sma.ma-0").datum(techan.indicator.sma().period(10)(data)).call(sma0);
		//        svg.select("g.sma.ma-1").datum(techan.indicator.sma().period(20)(data)).call(sma1);
		//        svg.select("g.ema.ma-2").datum(techan.indicator.ema().period(50)(data)).call(ema2);
		//        svg.select("g.macd .indicator-plot").datum(macdData).call(macd);
		//        svg.select("g.rsi .indicator-plot").datum(rsiData).call(rsi);

		svg.select("g.crosshair.ohlc").call(ohlcCrosshair).call(zoom);
		//       svg.select("g.crosshair.macd").call(macdCrosshair).call(zoom);
		//        svg.select("g.crosshair.rsi").call(rsiCrosshair).call(zoom);
		//        svg.select("g.trendlines").datum(trendlineData).call(trendline).call(trendline.drag);
		//        svg.select("g.supstances").datum(supstanceData).call(supstance).call(supstance.drag);

		svg.select("g.tradearrow").datum(g_trades).call(tradearrow);

		//svg.select("g.candlestick").call(candlestick.refresh);
		//svg.select("g.close.annotation").call(closeAnnotation.refresh);
		//svg.select("g.volume").call(volume.refresh);        

		// Stash for zooming
		zoomableInit = x.zoomable().domain([ indicatorPreRoll, data.length ])
				.copy(); // Zoom in a little to hide indicator preroll
		yInit = y.copy();
		yPercentInit = yPercent.copy();

	}
</script>

 -->
<script>
	$(document).ready(
			function() {
				console.log("ready!");

				//svg = d3.select("#chart");

				d3.json("../api/candles", load_data);

				//d3.json("../api/positions", load_trades);
				

				 (function(window) {
				 window.onresize = function() {
				 	d3.select('div#chart').call(g_bigchart.resize);
				 };
				 })(window);
				
				
			}
			

	);
	

	var parseDate = function(utcSeconds) {
		var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
		d.setUTCSeconds(utcSeconds);
		return d;
	}
	

	function load_trades(error, data) {
		/*         var trades = [
		 { date: data[67].date, type: "buy", price: data[67].low, low: data[67].low, high: data[67].high },
		 { date: data[100].date, type: "sell", price: data[100].high, low: data[100].low, high: data[100].high },
		 { date: data[130].date, type: "buy", price: data[130].low, low: data[130].low, high: data[130].high },
		 { date: data[120].date, type: "sell", price: data[120].low, low: data[120].low, high: data[120].high }
		 ];
		 */
		var trades = [];

		console.log("positions data len: " + data.length);
		//data = data.slice(0, 200).map(function(d) {
		for (var i = 0; i < data.length; i++) {

			d = data[i];
			if (d.closed_time && d.closed_time != "None") {
				//console.log ("closed_time: "+d.closed_time+" price:"+d.sell.price)
				trades.push({
					date : d3.isoParse(d.closed_time),
					type : "sell",
					price : d.sell.price,
					low : d.sell.price,
					high : d.sell.price
				});
			}

			if (d.open_time && d.open_time != "None") {
				//console.log ("open_time: "+d.open_time+" price:"+d.buy.price)
				trades.push({
					date : d3.isoParse(d.open_time),
					type : "buy",
					price : d.buy.price,
					low : d.buy.price,
					high : d.buy.price
				});
			}
		}
		
	}

		var g_bigchart ;
	function load_data(error, data) {

		//var accessor = candlestick.accessor();

		console.log("data len: " + data.length);
		//data = data.slice(0, 200).map(function(d) {
		data = data.map(function(d) {

			//console.log(d)
			return {
				date : parseDate(d.time),
				open : +d.open,
				high : +d.high,
				low : +d.low,
				close : +d.close,
				volume : +d.volume
			};
		}).sort(function(a, b) {
			return d3.ascending(a.date, b.date);
		});

		var big_data = {
				name : "BTC-USD",
				ohlc : data,
				preroll : 33
		};
		
		g_bigchart = BigChart (big_data);
		
		d3.select("#chart").call(g_bigchart);
		
	}

	function BigChart(stock) {

		var dim = {
			width : null,
			height : null,
			margin : {
				top : 25,
				right : 50,
				bottom : 25,
				left : 50
			},
			plot : {
				width : null,
				height : null
			},
			ohlc : {
				height : null
			},
			indicator : {
				height : null,
				padding : null,
				top : null,
				bottom : null
			}
		};

		var data = stock.ohlc, x = techan.scale.financetime(), y = d3
				.scaleLinear(), yPercent = y.copy(), yVolume = d3.scaleLinear(), candlestick = techan.plot
				.candlestick().xScale(x).yScale(y), volume = techan.plot
				.volume().accessor(candlestick.accessor()).xScale(x).yScale(
						yVolume), xAxis = d3.axisBottom(x), xAxisTop = d3
				.axisTop(x), timeAnnotation = techan.plot.axisannotation()
				.orient('bottom').axis(xAxis).format(d3.timeFormat('%Y-%m-%d'))
				.width(65), timeAnnotationTop = techan.plot.axisannotation()
				.orient('top').axis(xAxisTop).format(d3.timeFormat('%Y-%m-%d'))
				.width(65), yAxis = d3.axisRight(y), ohlcAnnotation = techan.plot
				.axisannotation().orient('right').axis(yAxis).format(
						d3.format(',.2f')), closeAnnotation = techan.plot
				.axisannotation().orient('right').accessor(
						candlestick.accessor()).axis(yAxis).format(
						d3.format(',.2f')), percentAxis = d3.axisLeft(yPercent)
				.tickFormat(d3.format('+.1%')), percentAnnotation = techan.plot
				.axisannotation().orient('left').axis(percentAxis), volumeAxis = d3
				.axisRight(yVolume).ticks(3).tickFormat(d3.format(',.3s')),
				volumeAnnotation = techan.plot.axisannotation().orient('right').axis(volumeAxis).width(35),
		        ohlcCrosshair = techan.plot.crosshair().xScale(x).yScale(y).xAnnotation([timeAnnotation, timeAnnotationTop])
		        .yAnnotation([ohlcAnnotation, percentAnnotation, volumeAnnotation]);

		/*
		 indicatorTop = d3.scaleLinear(),    
		 sma0 = techan.plot.sma().xScale(x).yScale(y),
		 sma1 = techan.plot.sma().xScale(x).yScale(y),
		 ema2 = techan.plot.ema().xScale(x).yScale(y),
		 macdScale = d3.scaleLinear(),
		 rsiScale = d3.scaleLinear(),
		 macd = techan.plot.macd().xScale(x).yScale(macdScale),
		 macdAxis = d3.axisRight(macdScale).ticks(3),
		 macdAnnotation = techan.plot.axisannotation().orient('right').axis(macdAxis).format(d3.format(',.2s')),
		 macdAxisLeft = d3.axisLeft(macdScale).ticks(3),
		 macdAnnotationLeft = techan.plot.axisannotation().orient('left').axis(macdAxisLeft).format(d3.format(',.2s')),
		 rsi = techan.plot.rsi().xScale(x).yScale(rsiScale),
		 rsiAxis = d3.axisRight(rsiScale).ticks(3),
		 rsiAnnotation = techan.plot.axisannotation().orient('right').axis(rsiAxis).format(d3.format(',.2s')),
		 rsiAxisLeft = d3.axisLeft(rsiScale).ticks(3),
		 rsiAnnotationLeft = techan.plot.axisannotation().orient('left').axis(rsiAxisLeft).format(d3.format(',.2s')),
		 macdCrosshair = techan.plot.crosshair().xScale(x).yScale(macdScale).xAnnotation([timeAnnotation, timeAnnotationTop]).yAnnotation([macdAnnotation, macdAnnotationLeft]),
		 rsiCrosshair = techan.plot.crosshair().xScale(x).yScale(rsiScale).xAnnotation([timeAnnotation, timeAnnotationTop]).yAnnotation([rsiAnnotation, rsiAnnotationLeft]),
		 trendline = techan.plot.trendline().xScale(x).yScale(y),
		 supstance = techan.plot.supstance().xScale(x).yScale(y).annotation([ohlcAnnotation, percentAnnotation]);
		 */

		function zoomed() {
			x.zoomable().domain(
					d3.event.transform.rescaleX(zoomableInit).domain());
			y.domain(d3.event.transform.rescaleY(yInit).domain());
			yPercent.domain(d3.event.transform.rescaleY(yPercentInit).domain());

			draw(g_data);
		}

		function bigchart(selection) {
			var svg = selection.append("svg"), defs = svg.append("defs");
			/* 
			 defs.append("clipPath")
			 .attr("id", "ohlcClip")
			 .append("rect")
			 .attr("x", 0)
			 .attr("y", 0);

			 defs.append("clipPath")
			 .attr("id", "supstanceClip")
			 .append("rect")
			 .attr("x", -dim.margin.left)
			 .attr("y", 0);

			 defs.selectAll(".indicatorClip").data([0, 1])
			 .enter()
			 .append("clipPath")
			 .attr("id", function(d, i) { return "indicatorClip-" + i; })
			 .attr("class", "indicatorClip")
			 .append("rect")
			 .attr("x", 0);

			 svg.append('text')
			 .attr("class", "version")
			 .style("text-anchor", "end")
			 .text("TechanJS v" + techan.version + ", D3 v" + d3.version);
			 */
			svg = svg.append("g").attr("class", "chart")
					.attr(
							"transform",
							"translate(" + dim.margin.left + ","
									+ dim.margin.top + ")");

			svg.append('text').attr("class", "symbol").attr("x", 5).attr("y",
					15).text(stock.name);

			svg.append("g").attr("class", "x axis bottom");

			svg.append("g").attr("class", "x axis top");

			var ohlcSelection = svg.append("g").attr("class", "ohlc").attr(
					"transform", "translate(0,0)");

			ohlcSelection.append("g").attr("class", "y axis");

			ohlcSelection.append("g").attr("class", "closeValue annotation up");

			ohlcSelection.append("g").attr("class", "volume").attr("clip-path",
					"url(#ohlcClip)");

			ohlcSelection.append("g").attr("class", "candlestick").attr(
					"clip-path", "url(#ohlcClip)");

			ohlcSelection.append("g").attr("class", "indicator sma ma-0").attr(
					"clip-path", "url(#ohlcClip)");

			ohlcSelection.append("g").attr("class", "indicator sma ma-1").attr(
					"clip-path", "url(#ohlcClip)");

			ohlcSelection.append("g").attr("class", "indicator ema ma-2").attr(
					"clip-path", "url(#ohlcClip)");

			ohlcSelection.append("g").attr("class", "percent axis");

			ohlcSelection.append("g").attr("class", "volume axis");

			/* 

			var indicatorSelection = svg.selectAll("svg > g.indicator").data(
					[ "macd", "rsi" ]).enter().append("g").attr("class",
					function(d) {
						return d + " indicator";
					});

			indicatorSelection.append("g").attr("class", "axis right");

			indicatorSelection.append("g").attr("class", "axis left");

			 indicatorSelection.append("g")
			 .attr("class", "indicator-plot")
			 .attr("clip-path", function(d, i) { return "url(#indicatorClip-" + i + ")"; });
			 */
			// Add trendlines and other interactions last to be above zoom pane
			svg.append('g').attr("class", "crosshair ohlc");
			/* 
			 svg.append('g')
			 .attr("class", "crosshair macd");

			 svg.append('g')
			 .attr("class", "crosshair rsi");

			 svg.append("g")
			 .attr("class", "trendlines analysis")
			 .attr("clip-path", "url(#ohlcClip)");
			 svg.append("g")
			 .attr("class", "supstances analysis");
			 */
			 
			var accessor = candlestick.accessor(), indicatorPreRoll = stock.preroll, postRollData = data
					.slice(indicatorPreRoll); // Don't show where indicators don't have data 

			x.domain(techan.scale.plot.time(data).domain());
			y.domain(techan.scale.plot.ohlc(postRollData).domain());
			yPercent.domain(techan.scale.plot.percent(y,
					accessor(data[indicatorPreRoll])).domain());
			yVolume.domain(techan.scale.plot.volume(postRollData).domain());
			/* 
			 var macdData = techan.indicator.macd()(data);
			 macdScale.domain(techan.scale.plot.macd(macdData).domain());
			 var rsiData = techan.indicator.rsi()(data);
			 rsiScale.domain(techan.scale.plot.rsi(rsiData).domain());

			 */
			x.zoomable().domain([ indicatorPreRoll, data.length ]); // Zoom in a little to hide indicator preroll
			resize(selection);

			svg.select("g.candlestick").datum(data).call(candlestick);
			svg.select("g.closeValue.annotation").datum(
					[ data[data.length - 1] ]).call(closeAnnotation);
			svg.select("g.volume").datum(data).call(volume);
			svg.select("g.crosshair.ohlc").call(ohlcCrosshair);

			/*     
			 svg.select("g.sma.ma-0").datum(techan.indicator.sma().period(10)(data)).call(sma0);
			 svg.select("g.sma.ma-1").datum(techan.indicator.sma().period(20)(data)).call(sma1);
			 svg.select("g.ema.ma-2").datum(techan.indicator.ema().period(50)(data)).call(ema2);
			 svg.select("g.macd .indicator-plot").datum(macdData).call(macd);
			 svg.select("g.rsi .indicator-plot").datum(rsiData).call(rsi);

			 svg.select("g.crosshair.macd").call(macdCrosshair);
			 svg.select("g.crosshair.rsi").call(rsiCrosshair);
			 svg.select("g.trendlines").datum(stock.trendlines).call(trendline).call(trendline.drag);
			 svg.select("g.supstances").datum(stock.supstances).call(supstance).call(supstance.drag);
			 */
			selection.call(draw);
		}

		bigchart.resize = function(selection) {
			selection.call(resize).call(draw);
		};

		function resize(selection) {
			dim.width = selection.node().clientWidth;
			dim.height = selection.node().clientHeight;
			dim.plot.width = dim.width - dim.margin.left - dim.margin.right;
			dim.plot.height = dim.height - dim.margin.top - dim.margin.bottom;
			dim.ohlc.height = dim.plot.height ;
			/*     
			 dim.indicator.height = dim.plot.height * 0.144444;
			 dim.indicator.padding = dim.plot.height * 0.01111111111;
			 dim.indicator.top = dim.ohlc.height + dim.indicator.padding;
			 dim.indicator.bottom = dim.indicator.top + dim.indicator.height + dim.indicator.padding;
			 */

			var xRange = [ 0, dim.plot.width ], yRange = [ dim.ohlc.height, 0 ], ohlcVerticalTicks = Math
					.min(10, Math.round(dim.height / 70)), xTicks = Math.min(
					10, Math.round(dim.width / 130));

			//indicatorTop.range([dim.indicator.top, dim.indicator.bottom]);
			x.range(xRange);
			xAxis.ticks(xTicks);
			xAxisTop.ticks(xTicks);
			y.range(yRange);
		    yAxis.ticks(ohlcVerticalTicks);
			yPercent.range(y.range());
			percentAxis.ticks(ohlcVerticalTicks);
			yVolume.range([ yRange[0], yRange[0] - 0.2 * yRange[0] ]);
			volumeAxis.ticks(Math.min(3, Math.round(dim.height / 150)));
			timeAnnotation.translate([ 0, dim.plot.height ]);
			ohlcAnnotation.translate([ xRange[1], 0 ]);
			
			closeAnnotation.translate([xRange[1], 0]);			
			ohlcCrosshair.verticalWireRange([0, dim.plot.height]);
			
			/*
			 macdScale.range([indicatorTop(0) + dim.indicator.height, indicatorTop(0)]);
			 rsiScale.range([indicatorTop(1) + dim.indicator.height, indicatorTop(1)]);
			 macdAnnotation.translate([xRange[1], 0]);
			 rsiAnnotation.translate([xRange[1], 0]);
			 macdCrosshair.verticalWireRange([0, dim.plot.height]);
			 rsiCrosshair.verticalWireRange([0, dim.plot.height]);

			 */
			selection.select("svg").attr("width", dim.width).attr("height",
					dim.height);
/* 
			selection.select("text.version").attr("x", dim.width - 5).attr("y",
					dim.height); */

			selection.selectAll("defs #ohlcClip > rect").attr("width",
					dim.plot.width).attr("height", dim.ohlc.height);

			selection.selectAll("defs #supstanceClip > rect").attr("width",
					dim.width).attr("height", dim.ohlc.height);
/* 
			selection.selectAll("defs .indicatorClip > rect").attr("y",
					function(d, i) {
						return indicatorTop(i);
					}).attr("width", dim.plot.width).attr("height",
					dim.indicator.height);
 */
			selection.select("g.x.axis.bottom").attr("transform",
					"translate(0," + dim.plot.height + ")");

			selection.select("g.ohlc g.y.axis").attr("transform",
					"translate(" + xRange[1] + ",0)");
/* 
			selection.selectAll("g.indicator g.axis.right").attr("transform",
					"translate(" + xRange[1] + ",0)");
			selection.selectAll("g.indicator g.axis.left").attr("transform",
					"translate(" + xRange[0] + ",0)");
 */
		}

		function draw(selection) {
			var svg = selection.select("svg");
			svg.select("g.x.axis.bottom").call(xAxis);
			svg.select("g.x.axis.top").call(xAxisTop);
		    svg.select("g.ohlc .axis").call(yAxis);
			svg.select("g.volume.axis").call(volumeAxis);
			svg.select("g.percent.axis").call(percentAxis);
			//	svg.select("g.tradearrow").datum(g_trades).call(tradearrow);

			//    svg.select("g.macd .axis.right").call(macdAxis);
			//    svg.select("g.rsi .axis.right").call(rsiAxis);
			//    svg.select("g.macd .axis.left").call(macdAxisLeft);
			//    svg.select("g.rsi .axis.left").call(rsiAxisLeft);

			// We know the data does not change, a simple refresh that does not perform data joins will suffice.
			svg.select("g.candlestick").call(candlestick.refresh);
			svg.select("g.closeValue.annotation").call(closeAnnotation.refresh);
			svg.select("g.volume").call(volume.refresh);
			//    svg.select("g .sma.ma-0").call(sma0.refresh);
			//    svg.select("g .sma.ma-1").call(sma1.refresh);
			//    svg.select("g .ema.ma-2").call(ema2.refresh);
			//    svg.select("g.macd .indicator-plot").call(macd.refresh);
			//    svg.select("g.rsi .indicator-plot").call(rsi.refresh);
			svg.select("g.crosshair.ohlc").call(ohlcCrosshair.refresh);

			//    svg.select("g.crosshair.macd").call(macdCrosshair.refresh);
			//    svg.select("g.crosshair.rsi").call(rsiCrosshair.refresh);
			//    svg.select("g.trendlines").call(trendline.refresh);
			//    svg.select("g.supstances").call(supstance.refresh)
			//      .selectAll("g.data .supstance").attr("clip-path", "url(#ohlcClip)"); // FIXME Component should do the clipping, too much internal knowledge here
		}

		return bigchart;
	}
</script>

<body>

	<div class="row align-items-start">
		<div class="col-12">
			<div class="navbar navbar-inverse navbar-static-top">
				<div class="container">
					<header class="clearfix">
						<h3 class="brand">
							<a href="/">OldMonk</a>
						</h3>
						<ul class="nav masthead-nav">
							<li><a href="../oldmonk"> Home</a></li>
							<li class="active"><a href="chart.html">Charts </a></li>
							<li><a href="/"> Trading</a></li>
							<li><a href="/"> Documentation</a></li>
						</ul>
					</header>
				</div>
			</div>
		</div>
	</div>
	<div class="jumbotron jumbotron-fluid">
		<div class="chartcontainer" id="chart">
		</div>
	</div>

	<footer class="footer">
		<div class="container">
			<p>
				<small>
					<div class="row">
						<em>&copy; 2017-2019 OldMonk Bot</em>
					</div>
				</small>

			</p>
		</div>
	</footer>
</body>
</html>